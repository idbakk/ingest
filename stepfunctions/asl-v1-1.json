{
  "Comment": "Ingest State Machine v1.1 - validation + manifest (extensible)",
  "StartAt": "InitContext",
  "States": {
    "InitContext": {
      "Comment": "Normalize incoming event into a stable internal context (job/policy/impl).",
      "Type": "Pass",
      "Parameters": {
        "job": {
          "job_id.$": "$.job_id",
          "project_code.$": "$.project_code"
        },
        "policy": {
          "ruleset_version": "v1.0",
          "job_id.$": "$.job_id",
          "project_code.$": "$.project_code"
        },
        "impl": {
          "s3": {
            "bucket.$": "$.bucket",
            "object_key.$": "$.object_key",
            "ingest_folder.$": "$.ingest_folder",
            "folder_path.$": "$.folder_path"
          },
          "event": {
            "created_at.$": "$.created_at",
            "trigger.$": "$.trigger"
          },
          "orchestration": {
            "execution_id.$": "$$.Execution.Id",
            "entered_time.$": "$$.State.EnteredTime"
          }
        },
        "results": {}
      },
      "ResultPath": "$",
      "Next": "UpdateJobStateValidating"
    },
    "UpdateJobStateValidating": {
      "Comment": "DynamoDB: set state = VALIDATING",
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-1:768979069717:function:ingest-update-job-state",
        "Payload": {
          "job_id.$": "$.job.job_id",
          "project_code.$": "$.job.project_code",
          "new_state": "VALIDATING",
          "trigger.$": "$.impl.event.trigger",
          "ruleset_version.$": "$.policy.ruleset_version",
          "execution_id.$": "$.impl.orchestration.execution_id",
          "entered_time.$": "$.impl.orchestration.entered_time"
        }
      },
      "ResultPath": "$.results.update_validating",
      "Next": "ValidateFiles"
    },
    "ValidateFiles": {
      "Comment": "List S3 once, apply validation rules, build inventory + stats.",
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-1:768979069717:function:ingest-validate-files",
        "Payload": {
          "job_id.$": "$.job.job_id",
          "project_code.$": "$.job.project_code",
          "bucket.$": "$.impl.s3.bucket",
          "folder_path.$": "$.impl.s3.folder_path",
          "object_key.$": "$.impl.s3.object_key",
          "ingest_folder.$": "$.impl.s3.ingest_folder",
          "trigger.$": "$.impl.event.trigger",
          "created_at.$": "$.impl.event.created_at",
          "ruleset_version.$": "$.policy.ruleset_version"
        }
      },
      "ResultPath": "$.results.validation",
      "Next": "ValidationChoice"
    },
    "ValidationChoice": {
      "Comment": "Proceed only if validation ok == true.",
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.results.validation.Payload.ok",
          "BooleanEquals": true,
          "Next": "UpdateJobStatePreflightValidated"
        }
      ],
      "Default": "UpdateJobStateFailedValidation"
    },
    "UpdateJobStatePreflightValidated": {
      "Comment": "DynamoDB: set state = PREFLIGHT_VALIDATED",
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-1:768979069717:function:ingest-update-job-state",
        "Payload": {
          "job_id.$": "$.job.job_id",
          "project_code.$": "$.job.project_code",
          "new_state": "PREFLIGHT_VALIDATED",
          "trigger.$": "$.impl.event.trigger",
          "ruleset_version.$": "$.policy.ruleset_version",
          "execution_id.$": "$.impl.orchestration.execution_id",
          "entered_time.$": "$.impl.orchestration.entered_time"
        }
      },
      "ResultPath": "$.results.update_preflight_validated",
      "Next": "NormalizeValidateResult"
    },
    "NormalizeValidateResult": {
      "Type": "Pass",
      "InputPath": "$.results.validation.Payload",
      "ResultPath": "$.validate_result",
      "Next": "WriteManifest"
    },
    "WriteManifest": {
      "Comment": "Write one manifest JSON (snapshot) to S3 and store manifest_s3_uri in DynamoDB (inside Lambda).",
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-1:768979069717:function:ingest-write-manifest",
        "Payload": {
          "job_id.$": "$.policy.job_id",
          "project_code.$": "$.policy.project_code",
          "policy.$": "$.policy",
          "impl.$": "$.impl",
          "validate_result.$": "$.validate_result"
        }
      },
      "ResultPath": "$.results.manifest",
      "Next": "UpdateJobStateDeepValidating"
    },
    "UpdateJobStateDeepValidating": {
      "Comment": "DynamoDB: set state = DEEP_VALIDATING (start of deep checks like checksum/codec).",
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-1:768979069717:function:ingest-update-job-state",
        "Payload": {
          "job_id.$": "$.job.job_id",
          "project_code.$": "$.job.project_code",
          "new_state": "DEEP_VALIDATING",
          "trigger.$": "$.impl.event.trigger",
          "ruleset_version.$": "$.policy.ruleset_version",
          "execution_id.$": "$.impl.orchestration.execution_id",
          "entered_time.$": "$.impl.orchestration.entered_time",
          "manifest_s3_uri.$": "$.results.manifest.Payload.manifest_s3_uri"
        }
      },
      "ResultPath": "$.results.update_deep_validating",
      "Next": "DetectMhlPresence"
    },
    "DetectMhlPresence": {
      "Comment": "Detect whether an .mhl exists for this delivery (drives checksum mode).",
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-1:768979069717:function:ingest-detect-mhl",
        "Payload": {
          "job_id.$": "$.job.job_id",
          "project_code.$": "$.job.project_code",
          "manifest_s3_uri.$": "$.results.manifest.Payload.manifest_s3_uri",
          "inventory.$": "$.validate_result.inventory"
         }
      },
      "ResultPath": "$.results.detect_mhl",
      "Next": "ChecksumModeChoice"
    },
    "ChecksumModeChoice": {
      "Comment": "Branch: if .mhl present -> VERIFY; else -> BASELINE/SKIP (v1).",
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.results.detect_mhl.Payload.mhl_present",
          "BooleanEquals": true,
          "Next": "ChecksumVerifyStub"
        }
      ],
      "Default": "ChecksumBaselineStub"
    },
    "ChecksumVerifyStub": {
      "Comment": "Stub: checksum verification against MHL (to be implemented).",
      "Type": "Pass",
      "ResultPath": "$.results.checksum",
      "Parameters": {
        "mode": "VERIFY_MHL",
        "ok": true,
        "reason": "CHECKSUM_VERIFY_NOT_IMPLEMENTED_YET"
      },
      "Next": "UpdateJobStateDeepValidated"
    },
    "ChecksumBaselineStub": {
      "Comment": "Stub: checksum baseline (no MHL) (to be implemented).",
      "Type": "Pass",
      "ResultPath": "$.results.checksum",
      "Parameters": {
        "mode": "BASELINE_ONLY",
        "ok": true,
        "reason": "CHECKSUM_BASELINE_NOT_IMPLEMENTED_YET"
      },
      "Next": "UpdateJobStateDeepValidated"
    },
    "UpdateJobStateDeepValidated": {
      "Comment": "DynamoDB: set state = DEEP_VALIDATED (deep validation complete).",
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-1:768979069717:function:ingest-update-job-state",
        "Payload": {
          "job_id.$": "$.job.job_id",
          "project_code.$": "$.job.project_code",
          "new_state": "DEEP_VALIDATED",
          "trigger.$": "$.impl.event.trigger",
          "ruleset_version.$": "$.policy.ruleset_version",
          "execution_id.$": "$.impl.orchestration.execution_id",
          "entered_time.$": "$.impl.orchestration.entered_time",
          "manifest_s3_uri.$": "$.results.manifest.Payload.manifest_s3_uri",
          "deep_validation_summary.$": "$.results.checksum"
        }
      },
      "ResultPath": "$.results.update_deep_validated",
      "Next": "Done"
    },
    "UpdateJobStateFailedValidation": {
      "Comment": "DynamoDB: set state = FAILED_VALIDATION and store errors",
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-1:768979069717:function:ingest-update-job-state",
        "Payload": {
          "job_id.$": "$.job.job_id",
          "project_code.$": "$.job.project_code",
          "new_state": "FAILED_VALIDATION",
          "trigger.$": "$.impl.event.trigger",
          "ruleset_version.$": "$.policy.ruleset_version",
          "execution_id.$": "$.impl.orchestration.execution_id",
          "entered_time.$": "$.impl.orchestration.entered_time",
          "validation_errors.$": "$.results.validation.Payload.errors"
        }
      },
      "ResultPath": "$.results.update_failed_validation",
      "Next": "Done"
    },
    "Done": {
      "Comment": "Final output keeps full context + results so future steps can be added easily.",
      "Type": "Pass",
      "End": true
    }
  }
}